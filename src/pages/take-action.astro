---
import Layout from '../layouts/Layout.astro';
import emailConfig from '../data/email-config.json';

const base = import.meta.env.BASE_URL;
---

<Layout title="Take Action — #NotSoRandyFine">
  <section class="py-12 bg-white">
    <div class="max-w-4xl mx-auto px-4">
      <h1 class="section-heading">Take Action</h1>
      <p class="text-gray-600 mb-8 max-w-2xl">
        Generate a personalized email to your representatives. Enter your zip code to find who represents you,
        choose your tone, and send a message that matters.
      </p>

      <!-- Step 1: Your Info -->
      <div class="card p-6 mb-6">
        <h2 class="text-lg font-bold text-navy-800 mb-4 flex items-center gap-2">
          <span class="w-8 h-8 bg-gradient-to-br from-navy-700 to-navy-900 text-white rounded-full flex items-center justify-center text-sm font-bold shadow-sm">1</span>
          Your Information
        </h2>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label for="sender-name" class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
            <input type="text" id="sender-name" placeholder="Your full name" class="input-styled" />
          </div>
          <div>
            <label for="zip-code" class="block text-sm font-medium text-gray-700 mb-1">Zip Code</label>
            <div class="flex gap-2">
              <input type="text" id="zip-code" placeholder="e.g., 33312" maxlength="5" pattern="[0-9]{5}" class="input-styled flex-1" />
              <button id="lookup-btn" class="btn-secondary text-sm !py-2.5">Find My Reps</button>
            </div>
          </div>
        </div>
        <div id="lookup-error" class="hidden mt-3 text-sm text-red-600 bg-red-50 p-3 rounded-lg"></div>
        <div id="lookup-loading" class="hidden mt-3 text-sm text-gray-500 flex items-center gap-2">
          <svg class="animate-spin w-4 h-4" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
          Looking up your representatives...
        </div>
      </div>

      <!-- Step 2: Your Representatives -->
      <div id="reps-section" class="card p-6 mb-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-navy-800 flex items-center gap-2">
            <span class="w-8 h-8 bg-gradient-to-br from-navy-700 to-navy-900 text-white rounded-full flex items-center justify-center text-sm font-bold shadow-sm">2</span>
            Your Representatives
          </h2>
          <div class="flex items-center gap-3">
            <span id="selection-count" class="text-sm text-gray-500"></span>
            <div class="flex gap-1">
              <button id="select-all-btn" class="text-xs px-3 py-1.5 rounded-full bg-navy-800 text-white hover:bg-navy-900 transition-colors font-medium">Select All</button>
              <button id="select-none-btn" class="text-xs px-3 py-1.5 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors font-medium">Select None</button>
            </div>
          </div>
        </div>
        <div id="reps-grid" class="space-y-4">
          <!-- Populated by JS -->
        </div>

        <!-- Custom recipient -->
        <div class="mt-4 pt-4 border-t border-gray-100">
          <button id="add-custom-btn" class="text-sm text-navy-600 hover:text-navy-800 font-medium flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Add Custom Recipient
          </button>
          <div id="custom-recipient-form" class="hidden mt-3 flex gap-2 flex-wrap">
            <input type="text" id="custom-name" placeholder="Name" class="flex-1 min-w-[120px] px-3 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-navy-800" />
            <input type="email" id="custom-email" placeholder="Email" class="flex-1 min-w-[160px] px-3 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-navy-800" />
            <button id="add-custom-submit" class="btn-secondary text-sm !py-2">Add</button>
          </div>
        </div>
      </div>

      <!-- Step 3: Compose -->
      <div id="compose-section" class="card p-6 mb-6 hidden">
        <h2 class="text-lg font-bold text-navy-800 mb-4 flex items-center gap-2">
          <span class="w-8 h-8 bg-gradient-to-br from-navy-700 to-navy-900 text-white rounded-full flex items-center justify-center text-sm font-bold shadow-sm">3</span>
          Compose Your Email
        </h2>

        <!-- Action type -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">What do you want to say?</label>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="action-selector">
            {Object.entries(emailConfig.actions).map(([key, action]) => (
              <button
                class={`action-btn px-3 py-2.5 rounded-lg text-sm font-medium border-2 transition-colors ${key === 'condemn' ? 'border-navy-800 bg-navy-800 text-white' : 'border-gray-200 text-gray-700 hover:border-navy-800'}`}
                data-action={key}
              >
                {action.label}
              </button>
            ))}
          </div>
        </div>

        <!-- Tone -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Choose your tone</label>
          <div class="flex flex-wrap gap-2" id="tone-selector">
            {emailConfig.tones.map(tone => (
              <button
                class={`tone-btn px-4 py-2 rounded-full text-sm font-medium border-2 transition-colors flex items-center gap-1.5 ${tone.id === 'formal' ? 'border-navy-800 bg-navy-800 text-white' : 'border-gray-200 text-gray-700 hover:border-navy-800'}`}
                data-tone={tone.id}
                title={tone.description}
              >
                <span>{tone.icon}</span> {tone.name}
              </button>
            ))}
          </div>
        </div>

        <!-- Selected evidence -->
        <div id="evidence-banner" class="hidden mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-sm font-medium text-amber-800">Selected evidence will be included:</p>
              <p id="evidence-title" class="text-sm text-amber-700 mt-1"></p>
            </div>
            <button id="clear-evidence" class="text-amber-600 hover:text-amber-800">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>

        <button id="generate-btn" class="btn-primary w-full text-lg">
          Generate Email
        </button>

        <div id="generate-loading" class="hidden mt-4 text-center text-gray-500 flex items-center justify-center gap-2">
          <svg class="animate-spin w-5 h-5" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
          Generating your personalized email...
        </div>
        <div id="generate-error" class="hidden mt-3 text-sm text-red-600 bg-red-50 p-3 rounded-lg"></div>
      </div>

      <!-- Step 4: Generated Emails -->
      <div id="results-section" class="hidden space-y-4">
        <h2 class="text-lg font-bold text-navy-800 flex items-center gap-2">
          <span class="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-full flex items-center justify-center text-sm font-bold shadow-sm">4</span>
          Your Emails Are Ready
        </h2>
        <div id="email-results" class="space-y-4">
          <!-- Populated by JS -->
        </div>

        <!-- Share section -->
        <div class="card p-6 mt-6 text-center">
          <h3 class="font-bold text-navy-800 mb-2">Spread the Word</h3>
          <p class="text-sm text-gray-600 mb-4">Help others take action too.</p>
          <div class="flex justify-center gap-3">
            <button id="share-twitter" class="inline-flex items-center gap-2 px-4 py-2 border-2 border-gray-800 text-gray-800 rounded-lg text-sm font-medium hover:bg-gray-800 hover:text-white hover:-translate-y-0.5 transition-all duration-200">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
              Share on X
            </button>
            <button id="share-facebook" class="inline-flex items-center gap-2 px-4 py-2 border-2 border-blue-600 text-blue-600 rounded-lg text-sm font-medium hover:bg-blue-600 hover:text-white hover:-translate-y-0.5 transition-all duration-200">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
              Share
            </button>
            <button id="share-copy" class="inline-flex items-center gap-2 px-4 py-2 border-2 border-gray-300 text-gray-600 rounded-lg text-sm font-medium hover:bg-gray-100 hover:-translate-y-0.5 transition-all duration-200">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
              Copy Link
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  import { lookupReps, formatRepTitle } from '../scripts/rep-lookup.js';
  import { generateEmail, generateFallbackEmail, copyToClipboard, createMailtoLink } from '../scripts/email-generator.js';
  import { trackAction } from '../scripts/gamification.js';
  import { shareOnTwitter, shareOnFacebook, copyLink } from '../scripts/share.js';

  // State
  let reps = [];
  let selectedReps = new Set();
  let stateLegislators = [];
  let selectedStateLegislators = new Set();
  let customRecipients = [];
  let selectedCustom = new Set();
  let selectedTone = 'formal';
  let selectedAction = 'condemn';
  let selectedEvidence = null;

  // Check for evidence from Evidence Wall
  const storedEvidence = sessionStorage.getItem('selectedEvidence');
  if (storedEvidence) {
    try {
      selectedEvidence = JSON.parse(storedEvidence);
      sessionStorage.removeItem('selectedEvidence');
      const banner = document.getElementById('evidence-banner');
      const titleEl = document.getElementById('evidence-title');
      if (banner && titleEl) {
        banner.classList.remove('hidden');
        titleEl.textContent = selectedEvidence.title;
      }
    } catch {}
  }

  // Check for action from Accountability page
  const params = new URLSearchParams(window.location.search);
  const actionParam = params.get('action');
  if (actionParam && ['condemn', 'thank', 'urge', 'callout'].includes(actionParam)) {
    selectedAction = actionParam;
    document.querySelectorAll('.action-btn').forEach(btn => {
      const isSelected = btn.getAttribute('data-action') === actionParam;
      btn.classList.toggle('border-navy-800', isSelected);
      btn.classList.toggle('bg-navy-800', isSelected);
      btn.classList.toggle('text-white', isSelected);
      btn.classList.toggle('border-gray-200', !isSelected);
      btn.classList.toggle('text-gray-700', !isSelected);
    });
  }

  // Clear evidence
  document.getElementById('clear-evidence')?.addEventListener('click', () => {
    selectedEvidence = null;
    document.getElementById('evidence-banner')?.classList.add('hidden');
  });

  // Rep lookup
  document.getElementById('lookup-btn')?.addEventListener('click', async () => {
    const zip = (document.getElementById('zip-code') as HTMLInputElement)?.value?.trim();
    if (!zip || zip.length !== 5) {
      showError('lookup-error', 'Please enter a valid 5-digit zip code.');
      return;
    }

    hideError('lookup-error');
    document.getElementById('lookup-loading')?.classList.remove('hidden');
    document.getElementById('lookup-btn')?.setAttribute('disabled', 'true');

    try {
      const data = await lookupReps(zip);
      reps = data.officials || [];
      stateLegislators = data.stateLegislators || [];

      if (reps.length === 0 && stateLegislators.length === 0) {
        showError('lookup-error', 'No representatives found for this zip code.');
        return;
      }

      // Auto-select direct reps (senators + district rep), not other state reps
      selectedReps = new Set();
      reps.forEach((rep, i) => {
        if (rep.directRep) selectedReps.add(i);
      });
      // Auto-select all state legislators
      selectedStateLegislators = new Set(stateLegislators.map((_, i) => i));
      // Auto-select all custom recipients
      selectedCustom = new Set(customRecipients.map((_, i) => i));

      renderReps();
      document.getElementById('reps-section')?.classList.remove('hidden');
      document.getElementById('compose-section')?.classList.remove('hidden');
    } catch (err) {
      // Fallback: show compose without reps
      showError('lookup-error', `Could not look up representatives: ${err.message}. You can still generate an email below.`);
      document.getElementById('compose-section')?.classList.remove('hidden');
    } finally {
      document.getElementById('lookup-loading')?.classList.add('hidden');
      document.getElementById('lookup-btn')?.removeAttribute('disabled');
    }
  });

  function renderRepCard(rep, index, set, groupClass, extraLabel = '') {
    const checked = set.has(index);
    const title = rep.office ? formatRepTitle(rep.office) : '';
    const party = rep.party || '';
    const partyColor = party === 'Democratic' ? 'text-blue-600' : party === 'Republican' ? 'text-red-600' : 'text-gray-600';
    const borderAccent = rep.directRep !== false ? 'border-l-navy-800' : 'border-l-gray-300 border-dashed';
    const photoHtml = rep.photoUrl
      ? `<img src="${rep.photoUrl}" alt="" class="w-10 h-10 rounded-full object-cover border border-gray-200 shrink-0" onerror="this.style.display='none'" />`
      : '';

    // Build contact info line
    let contactHtml = '';
    if (rep.emails && rep.emails.length > 0) {
      contactHtml = `<div class="text-xs text-navy-600 truncate mt-0.5">
        <svg class="w-3 h-3 inline mr-0.5 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
        ${rep.emails[0]}
      </div>`;
    } else if (rep.contactForm) {
      contactHtml = `<div class="text-xs text-navy-600 truncate mt-0.5">
        <svg class="w-3 h-3 inline mr-0.5 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
        <a href="${rep.contactForm}" target="_blank" rel="noopener" class="hover:underline" onclick="event.stopPropagation()">Contact Form</a>
      </div>`;
    } else if (rep.urls && rep.urls.length > 0) {
      contactHtml = `<div class="text-xs text-gray-400 truncate mt-0.5">
        <svg class="w-3 h-3 inline mr-0.5 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9"/></svg>
        <a href="${rep.urls[0]}" target="_blank" rel="noopener" class="hover:underline" onclick="event.stopPropagation()">${rep.urls[0].replace(/^https?:\/\/(www\.)?/, '').replace(/\/$/, '')}</a>
      </div>`;
    }

    // Phone line
    let phoneHtml = '';
    if (rep.phones && rep.phones.length > 0) {
      phoneHtml = `<div class="text-xs text-gray-400 truncate">
        <svg class="w-3 h-3 inline mr-0.5 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
        ${rep.phones[0]}
      </div>`;
    }

    return `
      <label class="flex items-center gap-4 p-4 rounded-lg border-2 border-l-4 ${borderAccent} cursor-pointer transition-colors ${checked ? 'border-navy-800 bg-navy-50' : 'border-gray-200 hover:border-gray-300'}" data-group="${groupClass}" data-index="${index}">
        <input type="checkbox" class="${groupClass}-checkbox w-5 h-5 rounded border-gray-300 text-navy-800 focus:ring-navy-800" data-group="${groupClass}" data-index="${index}" ${checked ? 'checked' : ''} />
        ${photoHtml}
        <div class="flex-1 min-w-0">
          <div class="font-semibold text-navy-800">${rep.name}${extraLabel}</div>
          <div class="text-sm text-gray-500 truncate">${title}${rep.district !== undefined && rep.district !== null ? ` (District ${rep.district})` : ''} ${party ? `· <span class="${partyColor}">${party}</span>` : ''}</div>
          ${contactHtml}
          ${phoneHtml}
        </div>
      </label>
    `;
  }

  function renderReps() {
    const grid = document.getElementById('reps-grid');
    if (!grid) return;

    let html = '';

    // Group federal reps
    const directFederal = reps.filter(r => r.directRep);
    const otherFederal = reps.filter(r => !r.directRep);

    // Section 1: Your Federal Representatives (direct reps)
    if (directFederal.length > 0) {
      html += `<div class="space-y-2">
        <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide flex items-center gap-2">
          Your Federal Representatives
          <span class="text-xs font-normal bg-navy-100 text-navy-700 px-2 py-0.5 rounded-full">${directFederal.length}</span>
        </h3>`;
      directFederal.forEach(rep => {
        const origIndex = reps.indexOf(rep);
        html += renderRepCard(rep, origIndex, selectedReps, 'fed', '');
      });
      html += '</div>';
    }

    // Section 2: Other State Federal Representatives (optional)
    if (otherFederal.length > 0) {
      html += `<div class="space-y-2">
        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide flex items-center gap-2">
          Other Federal Representatives
          <span class="text-xs font-normal bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">${otherFederal.length}</span>
          <span class="text-xs font-normal text-gray-400 italic">(optional)</span>
        </h3>`;
      otherFederal.forEach(rep => {
        const origIndex = reps.indexOf(rep);
        html += renderRepCard(rep, origIndex, selectedReps, 'fed', '');
      });
      html += '</div>';
    }

    // Section 3: State Legislators
    if (stateLegislators.length > 0) {
      html += `<div class="space-y-2">
        <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide flex items-center gap-2">
          Your State Legislators
          <span class="text-xs font-normal bg-green-100 text-green-700 px-2 py-0.5 rounded-full">${stateLegislators.length}</span>
        </h3>`;
      stateLegislators.forEach((rep, i) => {
        html += renderRepCard(rep, i, selectedStateLegislators, 'state', '');
      });
      html += '</div>';
    }

    // Section 4: Custom Recipients
    if (customRecipients.length > 0) {
      html += `<div class="space-y-2">
        <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide flex items-center gap-2">
          Custom Recipients
          <span class="text-xs font-normal bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full">${customRecipients.length}</span>
        </h3>`;
      customRecipients.forEach((rec, i) => {
        const checked = selectedCustom.has(i);
        html += `
          <label class="flex items-center gap-4 p-4 rounded-lg border-2 border-l-4 border-l-amber-400 cursor-pointer transition-colors ${checked ? 'border-navy-800 bg-navy-50' : 'border-gray-200 hover:border-gray-300'}" data-group="custom" data-index="${i}">
            <input type="checkbox" class="custom-checkbox w-5 h-5 rounded border-gray-300 text-navy-800 focus:ring-navy-800" data-group="custom" data-index="${i}" ${checked ? 'checked' : ''} />
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-navy-800">${rec.name}</div>
              <div class="text-sm text-gray-500 truncate">${rec.email}</div>
            </div>
            <button class="remove-custom-btn text-gray-400 hover:text-red-500 transition-colors p-1" data-custom-index="${i}" type="button">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </label>
        `;
      });
      html += '</div>';
    }

    grid.innerHTML = html;

    // Update selection count
    const totalSelected = selectedReps.size + selectedStateLegislators.size + selectedCustom.size;
    const totalAll = reps.length + stateLegislators.length + customRecipients.length;
    const countEl = document.getElementById('selection-count');
    if (countEl) countEl.textContent = `${totalSelected} of ${totalAll} selected`;

    // Attach checkbox listeners for federal reps
    grid.querySelectorAll('.fed-checkbox').forEach(cb => {
      cb.addEventListener('change', (e) => {
        const index = parseInt((e.target as HTMLInputElement).getAttribute('data-index') || '0');
        if ((e.target as HTMLInputElement).checked) {
          selectedReps.add(index);
        } else {
          selectedReps.delete(index);
        }
        renderReps();
      });
    });

    // Attach checkbox listeners for state legislators
    grid.querySelectorAll('.state-checkbox').forEach(cb => {
      cb.addEventListener('change', (e) => {
        const index = parseInt((e.target as HTMLInputElement).getAttribute('data-index') || '0');
        if ((e.target as HTMLInputElement).checked) {
          selectedStateLegislators.add(index);
        } else {
          selectedStateLegislators.delete(index);
        }
        renderReps();
      });
    });

    // Attach checkbox listeners for custom recipients
    grid.querySelectorAll('.custom-checkbox').forEach(cb => {
      cb.addEventListener('change', (e) => {
        const index = parseInt((e.target as HTMLInputElement).getAttribute('data-index') || '0');
        if ((e.target as HTMLInputElement).checked) {
          selectedCustom.add(index);
        } else {
          selectedCustom.delete(index);
        }
        renderReps();
      });
    });

    // Attach remove buttons for custom recipients
    grid.querySelectorAll('.remove-custom-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const index = parseInt((btn as HTMLElement).getAttribute('data-custom-index') || '0');
        customRecipients.splice(index, 1);
        // Rebuild selectedCustom set (indices shifted)
        selectedCustom = new Set(customRecipients.map((_, i) => i));
        renderReps();
      });
    });
  }

  // Select All / Select None
  document.getElementById('select-all-btn')?.addEventListener('click', () => {
    selectedReps = new Set(reps.map((_, i) => i));
    selectedStateLegislators = new Set(stateLegislators.map((_, i) => i));
    selectedCustom = new Set(customRecipients.map((_, i) => i));
    renderReps();
  });

  document.getElementById('select-none-btn')?.addEventListener('click', () => {
    selectedReps = new Set();
    selectedStateLegislators = new Set();
    selectedCustom = new Set();
    renderReps();
  });

  // Custom recipients
  document.getElementById('add-custom-btn')?.addEventListener('click', () => {
    document.getElementById('custom-recipient-form')?.classList.toggle('hidden');
  });

  document.getElementById('add-custom-submit')?.addEventListener('click', () => {
    const name = (document.getElementById('custom-name') as HTMLInputElement)?.value?.trim();
    const email = (document.getElementById('custom-email') as HTMLInputElement)?.value?.trim();
    if (name && email) {
      customRecipients.push({ name, email });
      selectedCustom.add(customRecipients.length - 1);
      (document.getElementById('custom-name') as HTMLInputElement).value = '';
      (document.getElementById('custom-email') as HTMLInputElement).value = '';
      document.getElementById('custom-recipient-form')?.classList.add('hidden');
      renderReps();
    }
  });

  // Tone selector
  document.querySelectorAll('.tone-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      selectedTone = btn.getAttribute('data-tone') || 'formal';
      document.querySelectorAll('.tone-btn').forEach(b => {
        const isSelected = b === btn;
        b.classList.toggle('border-navy-800', isSelected);
        b.classList.toggle('bg-navy-800', isSelected);
        b.classList.toggle('text-white', isSelected);
        b.classList.toggle('border-gray-200', !isSelected);
        b.classList.toggle('text-gray-700', !isSelected);
      });
    });
  });

  // Action selector
  document.querySelectorAll('.action-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      selectedAction = btn.getAttribute('data-action') || 'condemn';
      document.querySelectorAll('.action-btn').forEach(b => {
        const isSelected = b === btn;
        b.classList.toggle('border-navy-800', isSelected);
        b.classList.toggle('bg-navy-800', isSelected);
        b.classList.toggle('text-white', isSelected);
        b.classList.toggle('border-gray-200', !isSelected);
        b.classList.toggle('text-gray-700', !isSelected);
      });
    });
  });

  // Generate emails
  document.getElementById('generate-btn')?.addEventListener('click', async () => {
    const senderName = (document.getElementById('sender-name') as HTMLInputElement)?.value?.trim() || 'A Concerned Citizen';

    const recipients = [
      ...Array.from(selectedReps).map(i => reps[i]).filter(Boolean),
      ...Array.from(selectedStateLegislators).map(i => stateLegislators[i]).filter(Boolean),
      ...Array.from(selectedCustom).map(i => customRecipients[i]).filter(Boolean),
    ];

    if (recipients.length === 0 && reps.length > 0) {
      showError('generate-error', 'Please select at least one recipient.');
      return;
    }

    hideError('generate-error');
    document.getElementById('generate-loading')?.classList.remove('hidden');
    document.getElementById('generate-btn')?.setAttribute('disabled', 'true');

    const emailResults = [];

    // If no reps found, generate a generic email
    const targets = recipients.length > 0 ? recipients : [{ name: 'Representative', office: '', party: '' }];

    // Generate AI email for first rep, use fast fallback templates for the rest
    for (let i = 0; i < targets.length; i++) {
      const rep = targets[i];
      const repName = rep.name;
      const repTitle = rep.office ? formatRepTitle(rep.office) : 'Representative';

      try {
        let result;
        if (i === 0) {
          // Try AI generation for the first rep only
          try {
            result = await generateEmail({
              senderName,
              tone: selectedTone,
              action: selectedAction,
              repName,
              repTitle,
              selectedEvidence,
            });
          } catch {
            result = generateFallbackEmail({
              senderName,
              tone: selectedTone,
              action: selectedAction,
              repName,
              repTitle,
              selectedEvidence,
            });
          }
        } else {
          // Use instant fallback templates for remaining reps
          result = generateFallbackEmail({
            senderName,
            tone: selectedTone,
            action: selectedAction,
            repName,
            repTitle,
            selectedEvidence,
          });
        }

        emailResults.push({
          rep,
          ...result,
        });

        trackAction('email_generated');
        trackAction('rep_contacted', { repName });
      } catch (err) {
        console.error('Error generating email for', repName, err);
      }
    }

    document.getElementById('generate-loading')?.classList.add('hidden');
    document.getElementById('generate-btn')?.removeAttribute('disabled');

    if (emailResults.length > 0) {
      renderEmailResults(emailResults);
      document.getElementById('results-section')?.classList.remove('hidden');
      document.getElementById('results-section')?.scrollIntoView({ behavior: 'smooth' });
    } else {
      showError('generate-error', 'Failed to generate emails. Please try again.');
    }
  });

  function renderEmailResults(results) {
    const container = document.getElementById('email-results');
    if (!container) return;

    container.innerHTML = results.map((result, i) => {
      const repName = result.rep.name;
      const email = result.rep.emails?.[0] || result.rep.email || '';
      const mailtoLink = email ? createMailtoLink(email, result.subject, result.body) : '';
      const contactUrl = result.rep.contactForm || result.rep.urls?.[0] || '';

      return `
        <div class="card p-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h3 class="font-bold text-navy-800">To: ${repName}</h3>
              ${email ? `<p class="text-sm text-gray-500">${email}</p>` : ''}
            </div>
            <span class="text-xs bg-green-100 text-green-700 px-2.5 py-1 rounded-full font-medium">Ready</span>
          </div>

          <div class="mb-3">
            <label class="text-xs font-medium text-gray-500 uppercase">Subject</label>
            <p class="font-medium text-navy-800">${result.subject}</p>
          </div>

          <div class="mb-4">
            <label class="text-xs font-medium text-gray-500 uppercase">Body</label>
            <div class="mt-1 p-5 bg-white border border-gray-200 rounded-lg text-sm text-gray-700 whitespace-pre-wrap max-h-64 overflow-y-auto shadow-inner leading-relaxed" id="email-body-${i}">${escapeHtml(result.body)}</div>
          </div>

          <div class="flex flex-wrap gap-2">
            <button class="copy-email-btn btn-primary text-sm !py-2" data-index="${i}">
              Copy to Clipboard
            </button>
            ${mailtoLink ? `<a href="${mailtoLink}" class="btn-secondary text-sm !py-2">Open in Email App</a>` : ''}
            ${contactUrl ? `<a href="${contactUrl}" target="_blank" rel="noopener" class="inline-flex items-center gap-1.5 px-4 py-2 border-2 border-navy-800 text-navy-800 rounded-lg text-sm font-medium hover:bg-navy-800 hover:text-white hover:-translate-y-0.5 transition-all duration-200">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
              ${result.rep.contactForm ? 'Go to Contact Form' : 'Visit Website'}
            </a>` : ''}
          </div>
          <p class="copy-feedback hidden text-sm text-green-600 mt-2 font-medium" data-index="${i}">Copied!</p>
        </div>
      `;
    }).join('');

    container.querySelectorAll('.copy-email-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const index = btn.getAttribute('data-index');
        const bodyEl = document.getElementById(`email-body-${index}`);
        if (bodyEl) {
          const result = results[parseInt(index)];
          const fullText = `Subject: ${result.subject}\n\n${result.body}`;
          await copyToClipboard(fullText);
          trackAction('email_copied');

          // Green checkmark feedback
          const origText = btn.innerHTML;
          btn.innerHTML = '<svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied!';
          (btn as HTMLElement).classList.add('!bg-green-600', '!from-green-600', '!to-green-700');
          setTimeout(() => {
            btn.innerHTML = origText;
            (btn as HTMLElement).classList.remove('!bg-green-600', '!from-green-600', '!to-green-700');
          }, 2000);
        }
      });
    });
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showError(id, message) {
    const el = document.getElementById(id);
    if (el) {
      el.textContent = message;
      el.classList.remove('hidden');
    }
  }

  function hideError(id) {
    document.getElementById(id)?.classList.add('hidden');
  }

  // Share buttons
  const siteUrl = window.location.origin + '/';
  const shareText = 'I just emailed my representatives about Randy Fine\'s hateful rhetoric. You can too. #NotSoRandyFine';

  document.getElementById('share-twitter')?.addEventListener('click', () => {
    shareOnTwitter(shareText, siteUrl);
    trackAction('shared');
  });

  document.getElementById('share-facebook')?.addEventListener('click', () => {
    shareOnFacebook(siteUrl);
    trackAction('shared');
  });

  document.getElementById('share-copy')?.addEventListener('click', () => {
    copyLink(siteUrl);
    trackAction('shared');
  });
</script>
