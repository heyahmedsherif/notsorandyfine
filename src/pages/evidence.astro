---
import Layout from '../layouts/Layout.astro';
import EvidenceCard from '../components/EvidenceCard.astro';
import evidence from '../data/evidence.json';

const sorted = [...evidence].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
const categories = [...new Set(evidence.map(e => e.category))];

const categoryLabels: Record<string, string> = {
  'anti-muslim': 'Anti-Muslim',
  'anti-palestinian': 'Anti-Palestinian',
  'inflammatory-rhetoric': 'Inflammatory Rhetoric',
  'abuse-of-power': 'Abuse of Power',
  'voting-irregularity': 'Voting Irregularity',
};
---

<Layout title="Evidence Wall â€” #NotSoRandyFine">
  <section class="py-12 bg-white">
    <div class="max-w-4xl mx-auto px-4">
      <h1 class="section-heading">Evidence Wall</h1>
      <p class="text-gray-600 mb-8 max-w-2xl">
        A documented timeline of Randy Fine's hateful rhetoric and inflammatory actions.
        Every incident below is sourced from public records and news reporting.
      </p>

      <!-- Category filter -->
      <div class="flex flex-wrap gap-2 mb-8" id="category-filters">
        <button class="filter-btn active px-4 py-2 rounded-full text-sm font-medium bg-navy-800 text-white transition-colors" data-category="all">
          All ({evidence.length})
        </button>
        {categories.map(cat => {
          const count = evidence.filter(e => e.category === cat).length;
          return (
            <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors" data-category={cat}>
              {categoryLabels[cat] || cat} ({count})
            </button>
          );
        })}
      </div>

      <!-- Timeline -->
      <div class="space-y-4" id="evidence-timeline">
        {sorted.map(item => (
          <EvidenceCard {...item} />
        ))}
      </div>

      <div id="no-results" class="hidden text-center py-12 text-gray-500">
        No incidents found in this category.
      </div>
    </div>
  </section>
</Layout>

<script>
  // Category filtering
  const filterBtns = document.querySelectorAll('.filter-btn');
  const cards = document.querySelectorAll('.evidence-card');
  const noResults = document.getElementById('no-results');

  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const category = btn.getAttribute('data-category');

      filterBtns.forEach(b => {
        b.classList.remove('bg-navy-800', 'text-white', 'active');
        b.classList.add('bg-gray-100', 'text-gray-700');
      });
      btn.classList.add('bg-navy-800', 'text-white', 'active');
      btn.classList.remove('bg-gray-100', 'text-gray-700');

      let visibleCount = 0;
      cards.forEach(card => {
        const cardCat = card.getAttribute('data-category');
        const show = category === 'all' || cardCat === category;
        (card as HTMLElement).style.display = show ? '' : 'none';
        if (show) visibleCount++;
      });

      if (noResults) {
        noResults.classList.toggle('hidden', visibleCount > 0);
      }
    });
  });

  // "Use in Email" buttons
  document.querySelectorAll('.use-in-email-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const title = btn.getAttribute('data-evidence-title');
      const summary = btn.getAttribute('data-evidence-summary');
      const quote = btn.getAttribute('data-evidence-quote');

      const evidenceText = JSON.stringify({ title, summary, quote });
      sessionStorage.setItem('selectedEvidence', evidenceText);

      import('../scripts/gamification.js').then(m => m.trackAction('evidence_used'));

      const base = document.querySelector('link[rel="icon"]')?.getAttribute('href')?.replace('favicon.svg', '') || '/notsorandyfine/';
      window.location.href = `${base}take-action`;
    });
  });
</script>
